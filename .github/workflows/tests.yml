name: tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            device: linux
          - os: windows-latest
            device: windows
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
            channel: 'stable'
      - name: Pub get (workspace)
        run: flutter pub get

      # Run all package tests
      - name: Run all package tests
        run: |
          for dir in packages/*/; do
            if [ -d "$dir/test" ]; then
              echo "Testing $(basename $dir)..."
              cd "$dir"
              flutter pub get
              flutter test
              cd ../..
            fi
          done
        shell: bash

      # Run chenron unit tests
      - name: Run chenron unit tests
        working-directory: apps/chenron
        run: flutter test test/

      # Run chenron integration tests
      - name: Run chenron integration tests
        working-directory: apps/chenron
        run: |
          if [ -d "integration_test" ]; then
            flutter test integration_test/ -d ${{ matrix.device }}
          else
            echo "No integration_test directory, skipping."
          fi
        shell: bash
