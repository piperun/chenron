name: tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-offline:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
            channel: 'stable'
      - name: Pub get (workspace)
        run: flutter pub get
      
      # Run all package tests
      - name: Run all package tests
        run: |
          for dir in packages/*/; do
            if [ -d "$dir/test" ]; then
              echo "Testing $(basename $dir)..."
              cd "$dir"
              flutter pub get
              flutter test
              cd ../..
            fi
          done
        shell: bash
      
      # Run chenron unit tests
      - name: Run chenron unit tests
        working-directory: apps/chenron
        run: flutter test test/
      
      # Run chenron integration tests (excluding online tests)
      - name: Run chenron offline integration tests
        working-directory: apps/chenron
        run: flutter test integration_test/ --exclude-tags=online

  test-online:
    needs: test-offline
    if: ${{ secrets.CHENRON_ARCHIVE_ORG_KEY != '' && secrets.CHENRON_ARCHIVE_ORG_SECRET != '' }}
    runs-on: ubuntu-latest
    env:
      CHENRON_ARCHIVE_ORG_KEY: ${{ secrets.CHENRON_ARCHIVE_ORG_KEY }}
      CHENRON_ARCHIVE_ORG_SECRET: ${{ secrets.CHENRON_ARCHIVE_ORG_SECRET }}
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
            channel: 'stable'
      - name: Pub get (workspace)
        run: flutter pub get
      
      # Run chenron integration tests that require secrets
      - name: Run chenron online integration tests
        working-directory: apps/chenron
        run: flutter test integration_test/ --tags=online
