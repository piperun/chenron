name: release

on:
  push:
    tags:
      - 'chenron-v*'

permissions:
  contents: write

jobs:
  test:
    uses: ./.github/workflows/tests.yml

  extract-version:
    needs: test
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Extract version from tag
        id: version
        run: |
          VERSION="${GITHUB_REF_NAME#chenron-v}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Extracted version: $VERSION"

  build-windows:
    needs: extract-version
    runs-on: windows-latest
    env:
      VERSION: ${{ needs.extract-version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Pub get (workspace)
        run: flutter pub get

      - name: Override MSIX version
        working-directory: apps/chenron
        shell: pwsh
        run: |
          $content = Get-Content pubspec.yaml -Raw
          $content = $content -replace 'msix_version: .*', "msix_version: $env:VERSION.0"
          Set-Content pubspec.yaml $content

      - name: Build Windows release
        working-directory: apps/chenron
        run: flutter build windows --release

      - name: Create zip bundle
        shell: pwsh
        run: |
          Compress-Archive `
            -Path "apps/chenron/build/windows/x64/runner/Release/*" `
            -DestinationPath "chenron-$env:VERSION-windows-x64.zip"

      - name: Decode signing certificate
        shell: pwsh
        env:
          CERT_BASE64: ${{ secrets.MSIX_CERTIFICATE_BASE64 }}
        run: |
          $bytes = [Convert]::FromBase64String($env:CERT_BASE64)
          [IO.File]::WriteAllBytes("apps/chenron/cert.pfx", $bytes)

      - name: Create MSIX package
        working-directory: apps/chenron
        run: dart run msix:create

      - name: Rename MSIX
        shell: pwsh
        run: |
          $msix = Get-ChildItem -Path "apps/chenron/build/windows/x64/runner/Release/" -Filter "*.msix" | Select-Object -First 1
          if ($msix) {
            Copy-Item $msix.FullName "chenron-$env:VERSION-windows-x64.msix"
          } else {
            Write-Error "MSIX file not found"
            exit 1
          }

      - name: Copy install script
        shell: pwsh
        run: |
          Copy-Item "apps/chenron/windows/install.ps1" "install-chenron.ps1"

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: |
            chenron-${{ env.VERSION }}-windows-x64.zip
            chenron-${{ env.VERSION }}-windows-x64.msix
            install-chenron.ps1

  build-linux:
    needs: extract-version
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ needs.extract-version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Linux build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config \
            libgtk-3-dev liblzma-dev libstdc++-12-dev \
            flatpak flatpak-builder imagemagick

      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Pub get (workspace)
        run: flutter pub get

      - name: Convert SVG icon to PNG
        run: |
          convert -background none -resize 256x256 \
            apps/chenron/assets/icon.svg \
            apps/chenron/linux/com.chenron.chenron.png

      - name: Build Linux release
        working-directory: apps/chenron
        run: flutter build linux --release

      - name: Create tarball
        run: |
          tar -czf "chenron-$VERSION-linux-x64.tar.gz" \
            -C apps/chenron/build/linux/x64/release/bundle .

      - name: Install Flatpak runtime
        run: |
          flatpak remote-add --user --if-not-exists \
            flathub https://flathub.org/repo/flathub.flatpakrepo
          flatpak install --user -y flathub \
            org.freedesktop.Platform//24.08 \
            org.freedesktop.Sdk//24.08

      - name: Build Flatpak
        run: |
          flatpak-builder --user --install-deps-from=flathub \
            --force-clean --repo=flatpak-repo \
            flatpak-build \
            apps/chenron/linux/flatpak/com.chenron.chenron.yml

      - name: Export Flatpak bundle
        run: |
          flatpak build-bundle flatpak-repo \
            "chenron-$VERSION-linux-x64.flatpak" \
            com.chenron.chenron

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-artifacts
          path: |
            chenron-${{ env.VERSION }}-linux-x64.tar.gz
            chenron-${{ env.VERSION }}-linux-x64.flatpak

  create-release:
    needs: [extract-version, build-windows, build-linux]
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ needs.extract-version.outputs.version }}
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          merge-multiple: true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "Chenron ${{ env.VERSION }}"
          body: |
            ## Chenron ${{ env.VERSION }}

            ### Downloads
            | Platform | Bundle | Installer |
            |---|---|---|
            | Windows x64 | `chenron-${{ env.VERSION }}-windows-x64.zip` | `chenron-${{ env.VERSION }}-windows-x64.msix` |
            | Linux x64 | `chenron-${{ env.VERSION }}-linux-x64.tar.gz` | `chenron-${{ env.VERSION }}-linux-x64.flatpak` |

            ### Notes
            - **Windows MSIX**: Download `install-chenron.ps1` and the `.msix` into the same folder, then run the script in PowerShell as Admin. It installs the signing certificate and the app in one step.
            - **Linux Flatpak**: Install with `flatpak install chenron-${{ env.VERSION }}-linux-x64.flatpak`
            - **Zip/Tarball**: Extract and run the `chenron` binary directly (no signing needed).
          files: |
            chenron-${{ env.VERSION }}-windows-x64.zip
            chenron-${{ env.VERSION }}-windows-x64.msix
            install-chenron.ps1
            chenron-${{ env.VERSION }}-linux-x64.tar.gz
            chenron-${{ env.VERSION }}-linux-x64.flatpak
          draft: false
          prerelease: false
